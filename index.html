<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Minh Ngh Hub</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --bg: #0b0f15;
            --card: #111826;
            --muted: #93a0b3;
            --text: #e8eef7;
            --accent: #6aa6ff;
            --accent2: #9bffb7;
            --danger: #ff6b6b;
            --warn: #ffd166;
            --ok: #2dd4bf;
            --ring: rgba(106, 166, 255, .35);
            --br: 16px;
            --pad: 14px;
            --gap: 14px;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35);
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, #0a0e14, #0b111a);
            color: var(--text);
            font: 15px/1.45 system-ui, Segoe UI, Roboto, Inter, -apple-system, BlinkMacSystemFont
        }

        a {
            color: var(--accent);
            text-decoration: none
        }

        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            padding: 22px
        }

        .grid {
            display: grid;
            gap: var(--gap)
        }

        .cols {
            grid-template-columns: repeat(12, 1fr)
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .01));
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: var(--br);
            padding: var(--pad);
            box-shadow: var(--shadow)
        }

        .title {
            font-weight: 700;
            font-size: 20px;
            margin: 0 0 8px
        }

        .sub {
            color: var(--muted);
            font-size: 13px
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap
        }

        .sp {
            flex: 1
        }

        .btn {
            border: 1px solid rgba(255, 255, 255, .12);
            background: #0f1520;
            color: var(--text);
            padding: 9px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: .2s;
            font-weight: 600
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, .35)
        }

        .btn.primary {
            background: linear-gradient(90deg, #4f8cff, #7bc8ff);
            color: #0b0f15;
            border: none
        }

        .btn.ghost {
            background: transparent
        }

        .btn.warn {
            background: linear-gradient(90deg, #ffd166, #ffb703);
            color: #1a1200;
            border: none
        }

        .btn.danger {
            background: linear-gradient(90deg, #ff6b6b, #ff8fab);
            color: #250b0b;
            border: none
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            background: #0f1623;
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, .12);
            outline: none
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--ring)
        }

        label {
            font-size: 12px;
            color: var(--muted)
        }

        .pill {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .1);
            background: #0f1520
        }

        .list {
            display: grid;
            gap: 10px
        }

        .item {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            justify-content: space-between;
            padding: 10px;
            border: 1px dashed rgba(255, 255, 255, .12);
            border-radius: 12px
        }

        .muted {
            color: var(--muted)
        }

        .avatar {
            width: 88px;
            height: 88px;
            border-radius: 16px;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, .15)
        }

        .kpi {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .kpi .pill {
            background: linear-gradient(90deg, rgba(106, 166, 255, .15), rgba(45, 212, 191, .15));
            border: none
        }

        .board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px
        }

        .col {
            background: #0f1623;
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 12px;
            padding: 10px
        }

        .col h4 {
            margin: 0 0 6px;
            font-size: 14px;
            color: var(--muted)
        }

        .small {
            font-size: 12px
        }

        .badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .15)
        }

        .badge.ok {
            background: rgba(45, 212, 191, .15);
            border-color: rgba(45, 212, 191, .35)
        }

        .badge.hw {
            background: rgba(255, 209, 102, .15);
            border-color: rgba(255, 209, 102, .35)
        }

        .badge.due {
            background: rgba(255, 107, 107, .15);
            border-color: rgba(255, 107, 107, .45)
        }

        hr {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .12), transparent);
            margin: 8px 0
        }

        .empty {
            color: var(--muted);
            font-style: italic
        }

        /* Full-width boards use space intelligently */
        #classBoard {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        #lifeBoard {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        /* On wide screens, pin exact columns for clarity */
        @media (min-width: 1200px) {
            #classBoard {
                grid-template-columns: repeat(7, 1fr);
            }

            /* 7 ng√†y */
            #lifeBoard {
                grid-template-columns: repeat(4, 1fr);
            }

            /* S√°ng/Tr∆∞a/Chi·ªÅu/T·ªëi */
        }


        @media (max-width:1000px) {
            .cols {
                grid-template-columns: 1fr
            }
        }

        @media (max-width: 420px) {
            .col h4 {
                font-size: 13px
            }

            .item {
                padding: 8px
            }
        }
    </style>
</head>

<body>
    <div class="wrap grid cols">
        <!-- PROFILE -->
        <section class="card" style="grid-column: span 12">
            <div class="row">
                <img id="avatar" class="avatar" src="" alt="avatar" />
                <div class="sp">
                    <h2 class="title" id="name">Your Name</h2>
                    <div class="row small">
                        <span class="pill">üéÇ <span id="birthday">YYYY-MM-DD</span></span>
                        <span class="pill">üåç <span id="country">Country</span></span>
                        <span class="pill">üíû <span id="relationship">Relationship<a
                                    href="bunguwu.github.io/thaonguyencute">Th·∫£o Nguy√™n</a></span></span>
                    </div>
                    <p class="sub" id="bio" style="margin-top:8px">Short description‚Ä¶</p>
                    <div id="links" class="row small"></div>
                </div>
                <div class="row">
                    <button class="btn ghost" id="editProfileBtn">‚úèÔ∏è Edit</button>
                    <button class="btn" id="resetDataBtn" title="X√≥a d·ªØ li·ªáu local (kh√¥ng x√≥a CONFIG)">üßπ Reset
                        Local</button>

                    <!-- üîΩ ADD: Export/Import -->
                    <button class="btn" id="exportBtn" title="Xu·∫•t to√†n b·ªô d·ªØ li·ªáu">‚¨áÔ∏è Export</button>
                    <button class="btn" id="importBtn" title="Nh·∫≠p d·ªØ li·ªáu t·ª´ file">‚¨ÜÔ∏è Import</button>
                    <input type="file" id="importFile" accept="application/json" style="display:none" />
                </div>
            </div>
            <div class="kpi" style="margin-top:10px">
                <span class="pill">üìö L·ªõp h√¥m nay: <b id="kpi-classes">0</b></span>
                <span class="pill">üìù BTVN c√≤n l·∫°i: <b id="kpi-homework">0</b></span>
                <span class="pill">‚úÖ To-do ho√†n t·∫•t: <b id="kpi-done">0</b></span>
            </div>
        </section>

        <!-- TIMETABLE -->
        <section class="card" style="grid-column: span 12">

            <h3 class="title">üóìÔ∏è Th·ªùi kh√≥a bi·ªÉu </h3>

            <form id="classForm" class="grid" style="grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:10px">
                <div>
                    <label>Th·ª©</label>
                    <select name="day">
                        <option value="1">Th·ª© 2</option>
                        <option value="2">Th·ª© 3</option>
                        <option value="3">Th·ª© 4</option>
                        <option value="4">Th·ª© 5</option>
                        <option value="5">Th·ª© 6</option>
                        <option value="6">Th·ª© 7</option>
                        <option value="0">Ch·ªß nh·∫≠t</option>
                    </select>
                </div>
                <div><label>B·∫Øt ƒë·∫ßu</label><input name="start" type="time" required></div>
                <div><label>K·∫øt th√∫c</label><input name="end" type="time" required></div>
                <div><label>M√¥n</label><input name="subject" placeholder="To√°n, L√Ω‚Ä¶ " required></div>
                <div><label>Ghi ch√∫</label><input name="note" placeholder="Ph√≤ng, gi√°o vi√™n‚Ä¶"></div>
                <div>
                    <label>BTVN?</label>
                    <select name="homework">
                        <option value="no">Kh√¥ng</option>
                        <option value="yes">C√≥</option>
                    </select>
                </div>
                <div style="grid-column:span 6" class="row">
                    <button class="btn primary" type="submit">‚ûï Th√™m v√†o TKB</button>
                    <button class="btn ghost" type="button" id="clearClasses">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
                </div>
            </form>

            <!-- 7 c·ªôt ng√†y c·ªë ƒë·ªãnh -->
            <div class="board" id="classBoard">
                <div class="col">
                    <h4>Th·ª© 2</h4>
                    <div class="list" data-day="1"></div>
                </div>
                <div class="col">
                    <h4>Th·ª© 3</h4>
                    <div class="list" data-day="2"></div>
                </div>
                <div class="col">
                    <h4>Th·ª© 4</h4>
                    <div class="list" data-day="3"></div>
                </div>
                <div class="col">
                    <h4>Th·ª© 5</h4>
                    <div class="list" data-day="4"></div>
                </div>
                <div class="col">
                    <h4>Th·ª© 6</h4>
                    <div class="list" data-day="5"></div>
                </div>
                <div class="col">
                    <h4>Th·ª© 7</h4>
                    <div class="list" data-day="6"></div>
                </div>
                <div class="col">
                    <h4>Ch·ªß nh·∫≠t</h4>
                    <div class="list" data-day="0"></div>
                </div>
            </div>

            <p class="small muted" style="margin-top:6px">G·ª£i √Ω: Click ‚úèÔ∏è ƒë·ªÉ s·ª≠a (auto-prefill form), üóëÔ∏è ƒë·ªÉ xo√°.</p>
        </section>

        <!-- WEEKLY LIFESTYLE -->
        <section class="card" style="grid-column: span 12">

            <h3 class="title">üß≠ L·ªãch sinh ho·∫°t</h3>
            <form id="lifeForm" class="grid" style="grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:10px">
                <div>
                    <label>Th·ª©</label>
                    <select name="day">
                        <option value="1">Th·ª© 2</option>
                        <option value="2">Th·ª© 3</option>
                        <option value="3">Th·ª© 4</option>
                        <option value="4">Th·ª© 5</option>
                        <option value="5">Th·ª© 6</option>
                        <option value="6">Th·ª© 7</option>
                        <option value="0">Ch·ªß nh·∫≠t</option>
                    </select>
                </div>
                <div>
                    <label>Khung gi·ªù</label>
                    <select name="block">
                        <option>S√°ng</option>
                        <option>Tr∆∞a</option>
                        <option>Chi·ªÅu</option>
                        <option>T·ªëi</option>
                    </select>
                </div>
                <div><label>Ho·∫°t ƒë·ªông</label><input name="title" placeholder="Gym / H·ªçc TSA / ƒêi b·ªô‚Ä¶" required></div>
                <div><label>Chi ti·∫øt</label><input name="note" placeholder="Ghi ch√∫‚Ä¶"></div>
                <div>
                    <label>L·∫∑p tu·∫ßn?</label>
                    <select name="repeat">
                        <option value="yes">C√≥</option>
                        <option value="no">Kh√¥ng</option>
                    </select>
                </div>
                <div class="row" style="align-items:end">
                    <button class="btn primary" type="submit">‚ûï Th√™m l·ªãch</button>
                </div>
            </form>
            <div class="board" id="lifeBoard">
                <div class="col">
                    <h4>üåÖ S√°ng</h4>
                    <div class="list" data-block="S√°ng"></div>
                </div>
                <div class="col">
                    <h4>üå§ Tr∆∞a</h4>
                    <div class="list" data-block="Tr∆∞a"></div>
                </div>
                <div class="col">
                    <h4>üåá Chi·ªÅu</h4>
                    <div class="list" data-block="Chi·ªÅu"></div>
                </div>
                <div class="col">
                    <h4>üåô T·ªëi</h4>
                    <div class="list" data-block="T·ªëi"></div>
                </div>
            </div>
        </section>

        <!-- TO-DO -->
        <section class="card" style="grid-column: span 12">
            <div class="row">
                <h3 class="title">‚úÖ To-Do</h3>
                <div class="sp"></div>
                <button class="btn warn" id="rollToTomorrow" title="Chuy·ªÉn vi·ªác ch∆∞a xong h√¥m nay sang ng√†y mai">‚è≠Ô∏è
                    Build ng√†y mai</button>
            </div>

            <!-- QUICK ADD -->
            <form id="todoForm" class="grid" style="grid-template-columns:repeat(6,1fr);gap:10px;margin:10px 0">
                <div style="grid-column:span 3"><label>Nhi·ªám v·ª•</label><input name="title"
                        placeholder="√în TSA ch∆∞∆°ng 1‚Ä¶" required></div>
                <div><label>H·∫°n</label><input name="due" type="date" required></div>
                <div><label>Tag</label><input name="tag" placeholder="H·ªçc/Gym/Vi·ªác nh√†‚Ä¶"></div>
                <div class="row" style="align-items:center;gap:8px">
                    <label class="small">ƒê√£ xong?</label>
                    <input name="done" type="checkbox" />
                </div>

                <div class="row" style="align-items:end"><button class="btn primary" type="submit">‚ûï Th√™m</button></div>
            </form>

            <!-- FILTER BAR -->
            <div id="todoFilters" class="row" style="gap:8px;margin:6px 0;flex-wrap:wrap">
                <div class="pill">
                    <label class="small" style="margin-right:6px">Tr·∫°ng th√°i</label>
                    <select id="fStatus">
                        <option value="all">T·∫•t c·∫£</option>
                        <option value="open">Ch∆∞a xong</option>
                        <option value="done">ƒê√£ xong</option>
                    </select>
                </div>
                <div class="pill">
                    <label class="small" style="margin-right:6px">H·∫°n</label>
                    <select id="fDue">
                        <option value="today">H√¥m nay</option>
                        <option value="overdue">Qu√° h·∫°n</option>
                        <option value="tomorrow">Ng√†y mai</option>
                        <option value="upcoming">S·∫Øp t·ªõi (‚â• h√¥m nay)</option>
                        <option value="all">T·∫•t c·∫£</option>
                    </select>
                </div>
                <div class="pill"><input id="fTag" placeholder="Tag (vd: H·ªçc/Gym‚Ä¶)" /></div>
                <div class="pill"><input id="fSearch" placeholder="T√¨m theo ti√™u ƒë·ªÅ‚Ä¶" /></div>
                <button class="btn ghost" id="fClear" type="button">Reset l·ªçc</button>
            </div>

            <!-- BULK ACTIONS -->
            <div class="row" style="gap:8px;margin:6px 0;flex-wrap:wrap">
                <span class="pill small">ƒê√£ ch·ªçn: <b id="selCount">0</b></span>
                <button class="btn" id="bulkDone" type="button">‚úÖ ƒê√°nh d·∫•u xong</button>
                <button class="btn danger" id="bulkDelete" type="button">üóëÔ∏è Xo√°</button>
            </div>

            <!-- LISTS -->
            <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
                <div>
                    <h4 class="small muted">üìÖ View (theo b·ªô l·ªçc) ‚Äî <span id="todayLabel"></span></h4>
                    <div id="todoMain" class="list"></div>
                </div>
                <div>
                    <h4 class="small muted">üß© Ch∆∞a ho√†n th√†nh h√¥m nay</h4>
                    <div id="todoUnfinished" class="list"></div>
                </div>
            </div>
        </section>
        <!-- VOCAB TRAINER -->
        <section class="card" style="grid-column: span 12" id="vocabSection">
            <div class="row">
                <h3 class="title">üìò Vocab Trainer</h3>
                <div class="sp"></div>
                <span class="vocab-stat">üîî Due h√¥m nay: <b id="vocabDueToday">0</b></span>
                <button class="btn primary" id="vocabStartBtn">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu √¥n</button>
            </div>

            <div class="tabs">
                <button class="tab active" data-vtab="plan">Planner</button>
                <button class="tab" data-vtab="deck">Deck</button>
                <button class="tab" data-vtab="train">Train</button>
                <button class="tab" data-vtab="stats">Stats</button>
            </div>

            <!-- Planner -->
            <div data-vpane="plan">
                <div class="grid-2">
                    <div class="cardish">
                        <h4 class="small muted">üéØ M·ª•c ti√™u</h4>
                        <form id="vPlanForm" class="grid" style="grid-template-columns:repeat(2,1fr);gap:10px">
                            <div><label>T·ªïng s·ªë t·ª´</label><input name="total" type="number" min="1" value="200"></div>
                            <div><label>S·ªë ng√†y</label><input name="days" type="number" min="1" value="10"></div>
                            <div><label>B·∫Øt ƒë·∫ßu</label><input name="start" type="date"></div>
                            <div><label>K·∫øt th√∫c</label><input name="end" type="date" disabled></div>
                            <div style="grid-column:span 2" class="row"><button class="btn primary" type="submit">üíæ L∆∞u
                                    Planner</button></div>
                        </form>
                        <p class="small-muted" id="vPlanSummary"></p>
                    </div>

                    <div class="cardish">
                        <h4 class="small muted">‚öôÔ∏è Tu·ª≥ ch·ªânh √¥n</h4>
                        <div class="row" style="flex-wrap:wrap; gap:10px">
                            <span class="pill">Quota/ng√†y: <b id="vDailyQuota">0</b></span>
                            <span class="pill">Deck hi·ªán t·∫°i: <b id="vActiveDeckName">‚Äî</b></span>
                            <button class="btn ghost" id="vResetSM2">‚ôªÔ∏è Reset l·ªãch √¥n (ch·ªâ l·ªãch, kh√¥ng xo√° t·ª´)</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deck -->
            <div data-vpane="deck" style="display:none">
                <div class="grid-2">
                    <div class="cardish">
                        <h4 class="small muted">üì¶ Qu·∫£n l√Ω Deck</h4>
                        <form id="vDeckForm" class="row">
                            <input name="name" placeholder="T√™n deck (vd: IELTS Core)" required style="flex:1">
                            <button class="btn primary" type="submit">‚ûï T·∫°o deck</button>
                        </form>
                        <div id="vDeckList" class="list" style="margin-top:8px"></div>
                    </div>

                    <div class="cardish">
                        <h4 class="small muted">üì• Nh·∫≠p t·ª´</h4>
                        <form id="vImportForm" class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
                            <div style="grid-column:span 2">
                                <label>M·ªói d√≤ng 1 t·ª´ (English). C√≥ th·ªÉ th√™m nghƒ©a sau d·∫•u ‚Äú|‚Äù, vd: <i>robust|m·∫°nh
                                        m·∫Ω</i></label>
                                <textarea name="bulk" rows="6"
                                    placeholder="resilient|ki√™n c∆∞·ªùng&#10;coherent|m·∫°ch l·∫°c"></textarea>
                            </div>
                            <div>
                                <label>T·ª± enrich (API)</label>
                                <select name="enrich">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                            <div>
                                <label>Deck</label>
                                <select name="deck" id="vDeckSelect"></select>
                            </div>
                            <div style="grid-column:span 2" class="row">
                                <button class="btn primary" type="submit">‚¨ÜÔ∏è Import</button>
                                <span class="small-muted">S·∫Ω k√©o: synonyms, antonyms, part-of-speech; t·ª± t·∫°o forms c∆°
                                    b·∫£n.</span>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- Words in Active Deck -->
                <div class="cardish" style="margin-top:10px">
                    <h4 class="small muted">üóÇ T·ª´ trong deck ƒëang ch·ªçn</h4>
                    <div class="row" style="gap:8px;flex-wrap:wrap">
                        <label class="pill small">
                            Deck:
                            <select id="vActiveDeckSelect" style="margin-left:6px"></select>
                        </label>
                        <label class="pill small">
                            <input type="checkbox" id="vSelectAllWords" style="margin-right:6px"> Ch·ªçn t·∫•t c·∫£
                        </label>
                        <span class="pill small">ƒê√£ ch·ªçn: <b id="vSelWordsCount">0</b></span>
                        <button class="btn danger" id="vDeleteSelectedWords" type="button">üóëÔ∏è Xo√° t·ª´ ƒë√£ ch·ªçn</button>
                    </div>
                    <div id="vWordList" class="list" style="margin-top:8px"></div>
                </div>

            </div>

            <!-- Train -->
            <div data-vpane="train" style="display:none">
                <div class="row" style="margin-bottom:8px">
                    <span class="pill">Ch·∫ø ƒë·ªô:
                        <select id="vMode">
                            <option value="auto">Auto mix</option>
                            <option value="flash">Flashcards</option>
                            <option value="cloze">Cloze / ƒêi·ªÅn khuy·∫øt</option>
                            <option value="quiz">Mini Quiz</option>
                            <option value="sentence">T·ª± ƒë·∫∑t c√¢u</option>
                        </select>
                    </span>
                    <span class="pill">Batch:
                        <select id="vBatch">
                            <option>10</option>
                            <option selected>20</option>
                            <option>30</option>
                            <option>50</option>
                        </select>
                    </span>
                    <button class="btn" id="vStartSession">üöÄ Start Session</button>
                </div>

                <div id="vSession" class="cardish" style="display:none">
                    <div id="vCardArea"></div>
                    <div class="session-actions" style="margin-top:10px">
                        <div class="grade-row">
                            <span class="badge-info">ƒê√°nh gi√° (0‚Äì5):</span>
                            <label class="pill"><input type="radio" name="vGrade" value="0">0</label>
                            <label class="pill"><input type="radio" name="vGrade" value="1">1</label>
                            <label class="pill"><input type="radio" name="vGrade" value="2">2</label>
                            <label class="pill"><input type="radio" name="vGrade" value="3" checked>3</label>
                            <label class="pill"><input type="radio" name="vGrade" value="4">4</label>
                            <label class="pill"><input type="radio" name="vGrade" value="5">5</label>
                        </div>
                        <button class="btn primary" id="vSubmitGrade">‚úÖ L∆∞u & ti·∫øp</button>
                        <button class="btn ghost" id="vSkip">‚è≠Ô∏è B·ªè qua</button>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div data-vpane="stats" style="display:none">
                <div class="grid-2">
                    <div class="cardish">
                        <h4 class="small muted">üìä S·ªë li·ªáu</h4>
                        <div class="row" style="flex-wrap:wrap">
                            <span class="pill">T·ªïng t·ª´: <b id="vStatTotal">0</b></span>
                            <span class="pill">Due h√¥m nay: <b id="vStatDue">0</b></span>
                            <span class="pill">EF trung b√¨nh: <b id="vStatEF">‚Äî</b></span>
                        </div>
                    </div>
                    <div class="cardish">
                        <h4 class="small muted">üßπ D·ªçn d·∫πp</h4>
                        <div class="row">
                            <button class="btn danger" id="vDeleteDeck">üóëÔ∏è Xo√° deck ƒëang ch·ªçn</button>
                            <button class="btn ghost" id="vExportVocab">‚¨áÔ∏è Export Vocab</button>
                            <label class="btn ghost" for="vImportVocabFile">‚¨ÜÔ∏è Import Vocab</label>
                            <input type="file" id="vImportVocabFile" accept="application/json" style="display:none">
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- PARA SYSTEM -->
        <section class="card" style="grid-column: span 12">
            <div class="row">
                <h3 class="title">üì¶ PARA System</h3>
                <div class="sp"></div>
                <button class="btn primary" id="paraAddBtn">‚ûï Th√™m</button>
            </div>

            <div class="board" style="margin-top:10px">
                <div class="col">
                    <h4>üìå Projects</h4>
                    <div class="list" id="para-projects"></div>
                </div>
                <div class="col">
                    <h4>üß© Areas</h4>
                    <div class="list" id="para-areas"></div>
                </div>
                <div class="col">
                    <h4>üìö Resources</h4>
                    <div class="list" id="para-resources"></div>
                </div>
                <div class="col">
                    <h4>üóÑ Archives</h4>
                    <div class="list" id="para-archives"></div>
                </div>
            </div>
        </section>

    </div>

    <!-- EDIT PROFILE MODAL -->
    <dialog id="profileModal" style="border:none;border-radius:16px;padding:0;max-width:520px;width:92%">
        <form method="dialog" class="card" style="margin:0;background:#0f1623">
            <h3 class="title">‚úèÔ∏è C·∫≠p nh·∫≠t h·ªì s∆°</h3>
            <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
                <div style="grid-column:span 2"><label>·∫¢nh (URL)</label><input name="avatar"></div>
                <div><label>H·ªç t√™n</label><input name="name" required></div>
                <div><label>Ng√†y sinh</label><input name="birthday" type="date"></div>
                <div><label>Qu·ªëc gia</label><input name="country"></div>
                <div><label>Quan h·ªá</label><input name="relationship"></div>
                <div><label>T√™n NY (hi·ªÉn th·ªã link)</label><input name="rel_label" placeholder="T√™n ng∆∞·ªùi y√™u"></div>
                <div><label>Link profile (URL)</label><input name="rel_url" placeholder="https://..."></div>

                <div style="grid-column:span 2"><label>M√¥ t·∫£</label><textarea name="bio" rows="3"></textarea></div>
                <div style="grid-column:span 2"><label>Links MXH (m·ªói d√≤ng: label|url)</label><textarea name="links"
                        rows="3" placeholder="Facebook|https://facebook.com/you"></textarea></div>
            </div>
            <div class="row" style="margin-top:10px">
                <button class="btn ghost" value="cancel">H·ªßy</button>
                <div class="sp"></div>
                <button class="btn primary" value="save">L∆∞u</button>
            </div>
        </form>
    </dialog>


    <script>
        /* ======= SIMPLE CONFIG (Ch·ªânh trong VS Code n·∫øu mu·ªën seed d·ªØ li·ªáu) ======= */

        const CONFIG = {
            profile: {
                avatar: "1.jpg  ",
                name: "Minh Ngh",
                birthday: "2008-11-14",
                country: "Vi·ªát Nam",
                relationship: "Single",
                relationship_link: { label: "", url: "" }, // ‚Üê NEW (optional)
                bio: "H·ªçc sinh 12, target HUST AI",
                links: [
                    ["Facebook", "https://facebook.com/yourpage"],
                    ["GitHub", "https://github.com/yourname"],
                    ["LinkedIn", "https://www.linkedin.com/in/yourname"]
                ]
            },
            samples: {
                classes: [
                    { day: 1, start: "07:00", end: "07:45", subject: "To√°n", note: "P101", homework: "yes" },
                    { day: 1, start: "08:00", end: "08:45", subject: "L√Ω", note: "P204", homework: "no" },
                    { day: 2, start: "09:00", end: "09:45", subject: "Anh", note: "GV Lan", homework: "yes" }
                ],
                life: [
                    { day: 1, block: "S√°ng", title: "Ch·∫°y b·ªô", note: "3km", repeat: "yes" },
                    { day: 1, block: "Chi·ªÅu", title: "Gym", note: "Push day", repeat: "yes" },
                    { day: 6, block: "T·ªëi", title: "Xem phim", note: "Th∆∞ gi√£n", repeat: "no" }
                ],
                todos: [
                    { title: "√în TSA ‚Äî B·∫•t ƒë·∫≥ng th·ª©c", due: todayStr(), done: false, tag: "H·ªçc" },
                    { title: "So·∫°n b√†i thuy·∫øt tr√¨nh", due: addDaysStr(1), done: false, tag: "H·ªçc" }
                ]
            }
        };

        /* ======= UTILITIES ======= */
        function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

        let lifeEditingId = null; // ƒëang s·ª≠a m·ª•c LIFE n√†o (theo id)

        let classEditingId = null; // ƒëang s·ª≠a l·ªõp n√†o (ID) hay kh√¥ng

        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
        const DAYS = ["CN", "T2", "T3", "T4", "T5", "T6", "T7"];

        function escapeHtml(s = "") {
            return s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
        }
        function safeUrl(u = "") {
            try {
                const x = new URL(u.trim());
                if (x.protocol === "http:" || x.protocol === "https:") return x.href;
            } catch { }
            return ""; // reject non-http(s)
        }
        function renderRelationship(p) {
            const base = escapeHtml(p.relationship || "‚Äî");
            const linkObj = p.relationship_link || {};
            const label = (linkObj.label || "").trim();
            const url = safeUrl(linkObj.url || "");
            if (label && url) {
                return `${base} ( <a href="${url}" target="_blank" rel="noopener">` + escapeHtml(label) + `</a> )`;
            }
            // Back-compat: allow user to paste raw <a> in relationship field; sanitize to only <a href=http(s)>
            const raw = (p.relationship || "").trim();
            if (/<a\s[^>]*>.*<\/a>/i.test(raw)) {
                // very small sanitizer: keep only one anchor, strip others
                const m = raw.match(/<a\s+[^>]*href=["'](https?:\/\/[^"']+)["'][^>]*>(.*?)<\/a>/i);
                if (m) {
                    const url2 = safeUrl(m[1]);
                    const label2 = escapeHtml(m[2] || "link");
                    return `Dating with ( <a href="${url2}" target="_blank" rel="noopener">${label2}</a> )`;
                }
            }
            return base;
        }

        function cmpDate(a, b) { if (a === b) return 0; return a < b ? -1 : 1; }

        function todayStr() {
            const d = new Date();
            const iso = d.toISOString().slice(0, 10);
            return iso;
        }
        function addDaysStr(n, base = new Date()) {
            const d = new Date(base);
            d.setDate(d.getDate() + n);
            return d.toISOString().slice(0, 10);
        }
        // ======= BACKUP / IMPORT / EXPORT UTIL =======
        const SCHEMA_VERSION = 1;

        function download(filename, text) {
            const blob = new Blob([text], { type: "application/json;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
        }

        function safeParseJSON(str) {
            try { return JSON.parse(str); } catch { return null; }
        }

        function validatePayload(payload) {
            // K·ª≥ v·ªçng kh√≥a ch√≠nh
            const must = ["version", "exported_at", "data"];
            if (!payload || typeof payload !== "object") return "File kh√¥ng h·ª£p l·ªá.";
            for (const k of must) if (!(k in payload)) return `Thi·∫øu kh√≥a '${k}'.`;

            const d = payload.data || {};
            const keys = ["PROFILE", "CLASSES", "LIFE", "TODOS"];
            for (const k of keys) if (!(k in d)) return `Thi·∫øu data.${k}.`;

            // Ki·ªÉm tra d·∫°ng d·ªØ li·ªáu c∆° b·∫£n
            if (typeof d.PROFILE !== "object") return "PROFILE kh√¥ng h·ª£p l·ªá.";
            if (!Array.isArray(d.CLASSES)) return "CLASSES kh√¥ng h·ª£p l·ªá.";
            if (!Array.isArray(d.LIFE)) return "LIFE kh√¥ng h·ª£p l·ªá.";
            if (!Array.isArray(d.TODOS)) return "TODOS kh√¥ng h·ª£p l·ªá.";

            return null; // OK
        }

        function ensureIdsAfterImport() {
            // Reuse ensureIds & ensureClassIds logic
            const todos = (store.get(KEY.TODOS, []) || []).map(t => ({ ...t, id: t.id ? String(t.id) : uid() }));
            store.set(KEY.TODOS, todos);
            const classes = (store.get(KEY.CLASSES, []) || []).map(c => ({ ...c, id: c.id ? String(c.id) : uid() }));
            store.set(KEY.CLASSES, classes);
        }

        // Merge strategy (id-aware cho TODOS/CLASSES; append cho LIFE; replace PROFILE)
        function mergeArraysById(oldArr, newArr, idKey = "id") {
            const map = new Map((oldArr || []).map(x => [String(x[idKey] || ""), x]));
            for (const item of newArr || []) {
                const k = String(item[idKey] || "");
                if (k && map.has(k)) {
                    map.set(k, { ...map.get(k), ...item });
                } else if (k) {
                    map.set(k, { ...item });
                } else {
                    // n·∫øu item ch∆∞a c√≥ id -> g√°n m·ªõi
                    map.set(uid(), { ...item, [idKey]: uid() });
                }
            }
            return Array.from(map.values());
        }

        function exportAll() {
            const payload = {
                product: "MinhNgh Hub",
                version: SCHEMA_VERSION,
                exported_at: new Date().toISOString(),
                data: {
                    PROFILE: store.get(KEY.PROFILE, CONFIG.profile),
                    CLASSES: store.get(KEY.CLASSES, []),
                    LIFE: store.get(KEY.LIFE, []),
                    TODOS: store.get(KEY.TODOS, []),
                }
            };
            download(`minhngh_hub_export_${new Date().toISOString().slice(0, 10)}.json`, JSON.stringify(payload, null, 2));
        }

        function importAllFromText(text, { mode = "replace" } = {}) {
            const payload = safeParseJSON(text);
            const err = validatePayload(payload);
            if (err) { alert("Import l·ªói: " + err); return; }

            // Auto-backup tr∆∞·ªõc khi nh·∫≠p
            try {
                const backup = {
                    product: "MinhNgh Hub",
                    version: SCHEMA_VERSION,
                    exported_at: new Date().toISOString(),
                    data: {
                        PROFILE: store.get(KEY.PROFILE, CONFIG.profile),
                        CLASSES: store.get(KEY.CLASSES, []),
                        LIFE: store.get(KEY.LIFE, []),
                        TODOS: store.get(KEY.TODOS, []),
                    }
                };
                download(`minhngh_hub_autobackup_${new Date().toISOString().slice(0, 10)}.json`, JSON.stringify(backup, null, 2));
            } catch { }

            const d = payload.data;
            if (mode === "replace") {
                store.set(KEY.PROFILE, d.PROFILE);
                store.set(KEY.CLASSES, d.CLASSES);
                store.set(KEY.LIFE, d.LIFE);
                store.set(KEY.TODOS, d.TODOS);
            } else { // "merge"
                // PROFILE: replace c·ª©ng ƒë·ªÉ tr√°nh xung ƒë·ªôt
                store.set(KEY.PROFILE, d.PROFILE);

                // CLASSES/TODOS: merge theo id
                const mergedClasses = mergeArraysById(store.get(KEY.CLASSES, []), d.CLASSES, "id");
                const mergedTodos = mergeArraysById(store.get(KEY.TODOS, []), d.TODOS, "id");

                // LIFE: append + l·ªçc tr√πng th√¥ (day+block+title)
                const oldLife = store.get(KEY.LIFE, []);
                const keyLife = it => `${it.day}|${it.block}|${(it.title || "").trim().toLowerCase()}`;
                const seen = new Set(oldLife.map(keyLife));
                const appended = [...oldLife];
                for (const it of d.LIFE) {
                    const k = keyLife(it);
                    if (!seen.has(k)) { appended.push(it); seen.add(k); }
                }

                store.set(KEY.CLASSES, mergedClasses);
                store.set(KEY.LIFE, appended);
                store.set(KEY.TODOS, mergedTodos);
            }

            ensureIdsAfterImport();
            renderAll();
            alert("Import th√†nh c√¥ng.");
        }
        /* ======= STORAGE LAYER ======= */
        const todoFilter = { status: 'all', due: 'today', tag: '', q: '' };
        let selectedIds = new Set();

        const KEY = {
            PROFILE: "ph_profile",
            CLASSES: "ph_classes",
            LIFE: "ph_life",
            TODOS: "ph_todos"
        };
        const store = {
            get(k, fallback) {
                try { return JSON.parse(localStorage.getItem(k)) ?? fallback; } catch { return fallback; }
            },
            set(k, v) { localStorage.setItem(k, JSON.stringify(v)); },
            init() {
                if (!localStorage.getItem(KEY.PROFILE)) store.set(KEY.PROFILE, CONFIG.profile);
                if (!localStorage.getItem(KEY.CLASSES)) store.set(KEY.CLASSES, CONFIG.samples.classes);
                if (!localStorage.getItem(KEY.LIFE)) store.set(KEY.LIFE, CONFIG.samples.life);
                if (!localStorage.getItem(KEY.TODOS)) store.set(KEY.TODOS, CONFIG.samples.todos);
            },
            reset() {
                [KEY.PROFILE, KEY.CLASSES, KEY.LIFE, KEY.TODOS].forEach(k => localStorage.removeItem(k));
                store.init(); renderAll();
            }
        };

        /* ======= RENDER PROFILE ======= */
        function renderProfile() {
            const p = store.get(KEY.PROFILE, CONFIG.profile);
            $("#avatar").src = p.avatar || "";
            $("#name").textContent = p.name || "Your Name";
            $("#birthday").textContent = p.birthday || "YYYY-MM-DD";
            $("#country").textContent = p.country || "Country";
            $("#relationship").innerHTML = renderRelationship(p);

            $("#bio").textContent = p.bio || "";
            const links = $("#links"); links.innerHTML = "";
            (p.links || []).forEach(([label, url]) => {
                const a = document.createElement("a"); a.href = url; a.target = "_blank"; a.rel = "noopener";
                a.className = "pill"; a.textContent = label; links.appendChild(a);
            });
        }

        /* ======= RENDER CLASSES ======= */
        function renderClasses() {
            const data = store.get(KEY.CLASSES, []);
            // sort ·ªïn ƒë·ªãnh: ng√†y ‚Üí gi·ªù
            const sorted = [...data].sort((a, b) => (a.day - b.day) || a.start.localeCompare(b.start));

            // reset 7 c·ªôt
            $$('#classBoard .list').forEach(ul => ul.innerHTML = '');

            if (!sorted.length) {
                $$('#classBoard .list').forEach(ul => ul.innerHTML = `<div class="empty">Ch∆∞a c√≥ l·ªõp.</div>`);
                return;
            }

            sorted.forEach(c => {
                const container = $(`#classBoard .list[data-day="${c.day}"]`);
                const div = document.createElement('div'); div.className = 'item';
                div.innerHTML = `
      <div>
        <div class="row small">
          <span class="badge ok">${c.start}‚Äì${c.end}</span>
          ${c.homework === "yes" ? '<span class="badge hw">BTVN</span>' : ''}
        </div>
        <div style="margin-top:6px">
          <b>${c.subject}</b> <span class="muted">${c.note ? ('‚Ä¢ ' + c.note) : ''}</span>
        </div>
      </div>
      <div class="row">
        <button class="btn ghost" data-edit-class="${c.id}" title="S·ª≠a">‚úèÔ∏è</button>
        <button class="btn danger" data-del-class="${c.id}" title="Xo√°">üóëÔ∏è</button>
      </div>`;
                container?.appendChild(div);
            });

            // empty state cho c·ªôt tr·ªëng
            $$('#classBoard .list').forEach(ul => { if (!ul.children.length) ul.innerHTML = `<div class="empty">‚Äî</div>`; });

            // Xo√° theo ID (kh√¥ng l·ªách)
            $$('#classBoard [data-del-class]').forEach(btn => {
                btn.onclick = () => {
                    const id = btn.getAttribute('data-del-class');
                    const arr = store.get(KEY.CLASSES, []).filter(c => String(c.id) !== String(id));
                    store.set(KEY.CLASSES, arr);
                    if (classEditingId === id) classEditingId = null; // n·∫øu ƒëang s·ª≠a m·ª•c v·ª´a xo√°
                    renderClasses(); renderKPIs();
                };
            });

            // S·ª≠a: prefills + b·∫≠t edit mode (kh√¥ng remove tr∆∞·ªõc)
            $$('#classBoard [data-edit-class]').forEach(btn => {
                btn.onclick = () => {
                    const id = btn.getAttribute('data-edit-class');
                    const arr = store.get(KEY.CLASSES, []);
                    const c = arr.find(x => String(x.id) === String(id));
                    if (!c) return;

                    const f = $("#classForm");
                    f.day.value = c.day;
                    f.start.value = c.start;
                    f.end.value = c.end;
                    f.subject.value = c.subject;
                    f.note.value = c.note || "";
                    f.homework.value = c.homework || "no";

                    classEditingId = id; // b·∫≠t ch·∫ø ƒë·ªô s·ª≠a
                    // ƒë·ªïi n√∫t submit ƒë·ªÉ user nh·∫≠n bi·∫øt
                    const submitBtn = f.querySelector('button[type="submit"]');
                    if (submitBtn) { submitBtn.textContent = "üíæ L∆∞u thay ƒë·ªïi"; submitBtn.classList.add('primary'); }
                    f.scrollIntoView({ behavior: "smooth", block: "center" });
                };
            });
        }


        /* ======= RENDER LIFESTYLE (WEEKLY) ======= */
        function renderLife() {
            const data = store.get(KEY.LIFE, []);
            $$("#lifeBoard .list").forEach(ul => ul.innerHTML = "");
            if (!data.length) {
                $$("#lifeBoard .list").forEach(ul => ul.innerHTML = `<div class="empty">Ch∆∞a c√≥ m·ª•c n√†o.</div>`);
                return;
            }

            // sort hi·ªÉn th·ªã nh∆∞ng v·∫´n gi·ªØ id c·ªßa item
            const sorted = [...data].sort(
                (a, b) => a.block.localeCompare(b.block) || (a.day - b.day) || (a.title || "").localeCompare(b.title || "")
            );

            sorted.forEach(it => {
                const container = $(`#lifeBoard .list[data-block="${it.block}"]`);
                const div = document.createElement("div"); div.className = "item";
                div.innerHTML = `
      <div>
        <div class="row small">
          <span class="badge">${DAYS[it.day]}</span>
          <span class="badge ${it.repeat === 'yes' ? 'ok' : ''}">${it.repeat === 'yes' ? 'L·∫∑p tu·∫ßn' : 'M·ªôt l·∫ßn'}</span>
        </div>
        <div style="margin-top:6px"><b>${it.title}</b> <span class="muted">${it.note ? ("‚Ä¢ " + it.note) : ""}</span></div>
      </div>
      <div class="row">
        <button class="btn ghost" data-life-edit-id="${it.id}">‚úèÔ∏è</button>
        <button class="btn danger" data-life-del-id="${it.id}">üóëÔ∏è</button>
      </div>`;
                container?.appendChild(div);
            });

            // Delete by id
            $$("#lifeBoard [data-life-del-id]").forEach(btn => {
                btn.onclick = () => {
                    const id = String(btn.getAttribute("data-life-del-id"));
                    const arr = store.get(KEY.LIFE, []).filter(x => String(x.id) !== id);
                    store.set(KEY.LIFE, arr);
                    if (lifeEditingId === id) lifeEditingId = null; // n·∫øu ƒëang s·ª≠a ƒë√∫ng item v·ª´a xo√°
                    renderLife();
                };
            });

            // Edit by id (prefill form, KH√îNG splice)
            $$("#lifeBoard [data-life-edit-id]").forEach(btn => {
                btn.onclick = () => {
                    const id = String(btn.getAttribute("data-life-edit-id"));
                    const arr = store.get(KEY.LIFE, []);
                    const it = arr.find(x => String(x.id) === id);
                    if (!it) return;

                    const f = $("#lifeForm");
                    f.day.value = it.day;
                    f.block.value = it.block;
                    f.title.value = it.title;
                    f.note.value = it.note || "";
                    f.repeat.value = it.repeat || "yes";

                    lifeEditingId = id;
                    const submitBtn = f.querySelector('button[type="submit"]');
                    if (submitBtn) { submitBtn.textContent = "üíæ L∆∞u thay ƒë·ªïi"; submitBtn.classList.add('primary'); }
                    f.scrollIntoView({ behavior: "smooth", block: "center" });
                };
            });
        }

        /* ======= TO-DO ======= */
        function renderTodos() {
            const today = todayStr();
            $("#todayLabel").textContent = today;

            const data = store.get(KEY.TODOS, []);

            // View ch√≠nh theo b·ªô l·ªçc
            const main = data.filter(todoMatchesFilter).sort((a, b) => {
                if (a.done !== b.done) return a.done ? 1 : -1;
                const c = cmpDate(a.due, b.due); if (c !== 0) return c;
                return (a.title || '').localeCompare(b.title || '');
            });

            // Panel ‚Äúch∆∞a ho√†n th√†nh h√¥m nay‚Äù
            const unfinishedToday = data.filter(t => t.due === today && !t.done);

            const renderList = (root, items) => {
                root.innerHTML = "";
                if (!items.length) { root.innerHTML = `<div class="empty">Kh√¥ng c√≥ m·ª•c n√†o.</div>`; return; }
                items.forEach(t => {
                    const div = document.createElement("div"); div.className = "item";
                    const checked = selectedIds.has(String(t.id)) ? 'checked' : '';
                    div.innerHTML = `
        <div>
          <div class="row small">
            <label class="pill">
              <input type="checkbox" data-select="${t.id}" ${checked} style="margin-right:6px"/>
              <input type="checkbox" data-toggle="${t.id}" ${t.done ? "checked" : ""} style="margin:0 6px 0 0"/>${t.tag || "Task"}
            </label>
            <span class="badge ${cmpDate(t.due, today) === -1 && !t.done ? 'due' : ''}">Due: ${t.due}</span>
          </div>
          <div style="margin-top:6px"><b>${t.title}</b></div>
        </div>
        <div class="row">
          <button class="btn ghost" data-edit="${t.id}" title="S·ª≠a">‚úèÔ∏è</button>
          <button class="btn danger" data-del="${t.id}" title="Xo√°">üóëÔ∏è</button>
        </div>`;
                    root.appendChild(div);
                });
            };

            renderList($("#todoMain"), main);
            renderList($("#todoUnfinished"), unfinishedToday);

            // Toggle done
            $$('#todoMain [data-toggle], #todoUnfinished [data-toggle]').forEach(cb => {
                cb.onchange = () => {
                    const id = cb.getAttribute('data-toggle');
                    const arr = store.get(KEY.TODOS, []);
                    const i = arr.findIndex(x => String(x.id) === String(id));
                    if (i > -1) { arr[i].done = cb.checked; store.set(KEY.TODOS, arr); renderKPIs(); renderTodos(); }
                };
            });

            // Select for bulk
            $$('#todoMain [data-select]').forEach(cb => {
                cb.onchange = () => {
                    const id = cb.getAttribute('data-select');
                    if (cb.checked) selectedIds.add(String(id)); else selectedIds.delete(String(id));
                    $("#selCount").textContent = selectedIds.size;
                };
            });
            $("#selCount").textContent = selectedIds.size;

            // Delete
            $$('#todoMain [data-del], #todoUnfinished [data-del]').forEach(btn => {
                btn.onclick = () => {
                    const id = btn.getAttribute('data-del');
                    const arr = store.get(KEY.TODOS, []).filter(t => String(t.id) !== String(id));
                    selectedIds.delete(String(id));
                    store.set(KEY.TODOS, arr); renderTodos(); renderKPIs();
                }
            });

            $$('#todoMain [data-edit], #todoUnfinished [data-edit]').forEach(btn => {
                btn.onclick = () => {
                    const id = btn.getAttribute('data-edit');
                    const arr = store.get(KEY.TODOS, []);
                    const i = arr.findIndex(x => String(x.id) === String(id));
                    if (i > -1) {
                        const t = arr[i];
                        const f = $("#todoForm");
                        f.title.value = t.title;
                        f.due.value = t.due;
                        f.tag.value = t.tag || "";
                        if (f.done) f.done.checked = !!t.done;   // ‚Üê NEW: prefill checkbox

                        // remove b·∫£n c≈©, submit form s·∫Ω add l·∫°i (c√°ch s·ª≠a nhanh)
                        arr.splice(i, 1);
                        store.set(KEY.TODOS, arr);
                        renderTodos();
                        f.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                }
            });

        }

        function renderKPIs() {
            const classes = store.get(KEY.CLASSES, []);
            const todayDow = new Date().getDay();
            const classToday = classes.filter(c => +c.day === todayDow).length;
            const homework = classes.filter(c => c.homework === "yes").length;

            const todos = store.get(KEY.TODOS, []);
            const t = todayStr();
            const doneToday = todos.filter(x => x.due === t && x.done).length;

            $("#kpi-classes").textContent = classToday;
            $("#kpi-homework").textContent = homework;
            $("#kpi-done").textContent = doneToday;
        }


        /* ======= INIT + EVENTS ======= */

        function uid() {
            return Math.random().toString(36).slice(2) + Date.now().toString(36);
        }
        function ensureIds() {
            const arr = store.get(KEY.TODOS, []).map(t => ({ ...t, id: t.id ? String(t.id) : uid() }));
            store.set(KEY.TODOS, arr);
        }
        function ensureLifeIds() {
            const arr = (store.get(KEY.LIFE, []) || []).map(it => ({
                ...it,
                id: it.id ? String(it.id) : uid()
            }));
            store.set(KEY.LIFE, arr);
        }

        function todoMatchesFilter(t) {
            const today = todayStr();

            if (todoFilter.status === 'open' && t.done) return false;
            if (todoFilter.status === 'done' && !t.done) return false;

            if (todoFilter.due === 'today' && t.due !== today) return false;
            if (todoFilter.due === 'overdue' && !(cmpDate(t.due, today) === -1 && !t.done)) return false;
            if (todoFilter.due === 'tomorrow' && t.due !== addDaysStr(1)) return false;
            if (todoFilter.due === 'upcoming' && cmpDate(t.due, today) === -1) return false;

            if (todoFilter.tag) {
                const tg = (t.tag || '').toLowerCase(); if (!tg.includes(todoFilter.tag.toLowerCase())) return false;
            }
            if (todoFilter.q) {
                const ti = (t.title || '').toLowerCase(); if (!ti.includes(todoFilter.q.toLowerCase())) return false;
            }
            return true;
        }



        function renderAll() { renderProfile(); renderClasses(); renderLife(); ensureIds(); renderTodos(); renderKPIs(); }
        // ===== Vocab Core Shim ‚Äî fix undefined functions, zero backend, localStorage =====
        const VOCAB_STORE_KEY = "ph_vocab_store_v1";

        // helper id
        function newId() { try { return uid(); } catch { return Math.random().toString(36).slice(2) + Date.now().toString(36); } }

        // state helpers
        function ensureVocab() {
            const raw = localStorage.getItem(VOCAB_STORE_KEY);
            if (raw) {
                try { return JSON.parse(raw); } catch { /* fallthrough */ }
            }
            const init = { decks: {}, activeDeckId: null };
            localStorage.setItem(VOCAB_STORE_KEY, JSON.stringify(init));
            return init;
        }
        function saveVocab(v) {
            localStorage.setItem(VOCAB_STORE_KEY, JSON.stringify(v));
        }

        // selection state for bulk ops
        let selectedWordIds = new Set();

        // render: deck list + selects + active deck label
        function renderVocabDeckList() {
            const v = ensureVocab();
            const list = document.getElementById("vDeckList");
            const selImport = document.getElementById("vDeckSelect");
            const selActive = document.getElementById("vActiveDeckSelect");
            const activeName = document.getElementById("vActiveDeckName");

            // decks -> array
            const decks = Object.values(v.decks);
            // list
            if (list) {
                list.innerHTML = decks.length ? "" : `<div class="empty">Ch∆∞a c√≥ deck.</div>`;
                decks.forEach(d => {
                    const item = document.createElement("div");
                    item.className = "item";
                    item.innerHTML = `
        <div>
          <div><b>${escapeHtml(d.name)}</b></div>
          <div class="small muted">ID: ${d.id}</div>
        </div>
        <div class="row">
          <button class="btn ghost" data-vset-active="${d.id}">
            ${v.activeDeckId === d.id ? "‚úÖ Active" : "Set active"}
          </button>
          <button class="btn danger" data-vdelete-deck="${d.id}">üóëÔ∏è</button>
        </div>`;
                    list.appendChild(item);
                });

                // bind actions
                list.querySelectorAll("[data-vset-active]").forEach(btn => {
                    btn.onclick = () => {
                        const id = btn.getAttribute("data-vset-active");
                        const vv = ensureVocab();
                        if (!vv.decks[id]) return;
                        vv.activeDeckId = id; saveVocab(vv);
                        renderVocabDeckList(); renderVocabWords();
                    };
                });
                list.querySelectorAll("[data-vdelete-deck]").forEach(btn => {
                    btn.onclick = () => {
                        const id = btn.getAttribute("data-vdelete-deck");
                        const vv = ensureVocab();
                        if (!vv.decks[id]) return;
                        if (!confirm(`Xo√° deck "${vv.decks[id].name}"?`)) return;
                        delete vv.decks[id];
                        vv.activeDeckId = Object.keys(vv.decks)[0] || null;
                        saveVocab(vv);
                        selectedWordIds.clear();
                        const master = document.getElementById("vSelectAllWords"); if (master) master.checked = false;
                        document.getElementById("vSelWordsCount").textContent = 0;
                        renderVocabDeckList(); renderVocabWords();
                    };
                });
            }

            // populate selects
            const ids = Object.keys(v.decks);
            if (selImport) {
                selImport.innerHTML = ids.length ? "" : `<option value="">(Ch∆∞a c√≥ deck)</option>`;
                ids.forEach(id => {
                    const opt = document.createElement("option");
                    opt.value = id; opt.textContent = v.decks[id].name;
                    selImport.appendChild(opt);
                });
                if (v.activeDeckId && v.decks[v.activeDeckId]) selImport.value = v.activeDeckId;
            }
            if (selActive) {
                selActive.innerHTML = ids.length ? "" : `<option value="">(Ch∆∞a c√≥ deck)</option>`;
                ids.forEach(id => {
                    const opt = document.createElement("option");
                    opt.value = id; opt.textContent = v.decks[id].name;
                    selActive.appendChild(opt);
                });
                if (v.activeDeckId && v.decks[v.activeDeckId]) selActive.value = v.activeDeckId;
            }

            // label
            if (activeName) {
                activeName.textContent = v.activeDeckId ? (v.decks[v.activeDeckId]?.name || "‚Äî") : "‚Äî";
            }
            // KPI badge in header (n·∫øu mu·ªën c√≥)
            const vocabDueToday = document.getElementById("vocabDueToday");
            if (vocabDueToday) { vocabDueToday.textContent = 0; } // ch∆∞a g·∫Øn SRS => 0
        }

        // render: word list for active deck + bind selection checkboxes
        function renderVocabWords() {
            const v = ensureVocab();
            const panel = document.getElementById("vWordList");
            if (!panel) return;

            const deck = v.activeDeckId ? v.decks[v.activeDeckId] : null;
            if (!deck) {
                panel.innerHTML = `<div class="empty">Ch∆∞a ch·ªçn deck.</div>`;
                return;
            }

            const words = deck.words || [];
            panel.innerHTML = words.length ? "" : `<div class="empty">Deck tr·ªëng.</div>`;
            words.forEach(w => {
                const row = document.createElement("div");
                row.className = "item";
                const checked = selectedWordIds.has(String(w.id)) ? "checked" : "";
                row.innerHTML = `
      <label class="pill small">
        <input type="checkbox" data-word-id="${w.id}" ${checked} style="margin-right:6px"> Ch·ªçn
      </label>
      <div class="sp">
        <b>${escapeHtml(w.term)}</b> <span class="muted">‚Ä¢ ${escapeHtml(w.meaning || "")}</span>
      </div>
      <div class="row">
        <button class="btn danger" data-del-word="${w.id}">üóëÔ∏è</button>
      </div>`;
                panel.appendChild(row);
            });

            // bind selection
            panel.querySelectorAll("[data-word-id]").forEach(cb => {
                cb.onchange = () => {
                    const id = String(cb.getAttribute("data-word-id"));
                    if (cb.checked) selectedWordIds.add(id); else selectedWordIds.delete(id);
                    const cnt = document.getElementById("vSelWordsCount"); if (cnt) cnt.textContent = selectedWordIds.size;
                };
            });

            // bind per-item delete
            panel.querySelectorAll("[data-del-word]").forEach(btn => {
                btn.onclick = () => {
                    const id = String(btn.getAttribute("data-del-word"));
                    const vv = ensureVocab();
                    const did = vv.activeDeckId;
                    if (!did || !vv.decks[did]) return;
                    vv.decks[did].words = (vv.decks[did].words || []).filter(x => String(x.id) !== id);
                    saveVocab(vv);
                    selectedWordIds.delete(id);
                    const cnt = document.getElementById("vSelWordsCount"); if (cnt) cnt.textContent = selectedWordIds.size;
                    renderVocabWords();
                };
            });
        }
        // ===== End Vocab Core Shim =====s
        // ===== Vocab Trainer + SM-2 (plug-in v√†o Shim) =====

        // --- Utilities ---
        function isoToday() { return new Date().toISOString().slice(0, 10); }
        function addDaysISO(n, base) {
            const d = base ? new Date(base) : new Date(); d.setDate(d.getDate() + n);
            return d.toISOString().slice(0, 10);
        }
        function ensureWordSchedule(w) {
            if (!w) return w;
            if (w.ef == null) w.ef = 2.5;
            if (w.rep == null) w.rep = 0;
            if (w.interval == null) w.interval = 0;
            if (!w.due) w.due = isoToday();
            if (!w.last) w.last = 0;
            if (!Array.isArray(w.synonyms)) w.synonyms = [];
            if (!Array.isArray(w.antonyms)) w.antonyms = [];
            if (!Array.isArray(w.pos)) w.pos = [];
            if (!w.example) w.example = "";
            if (!w.forms) w.forms = {};
            return w;
        }
        function normalizeAllWords() {
            const v = ensureVocab();
            Object.values(v.decks).forEach(d => {
                d.words = (d.words || []).map(ensureWordSchedule);
            });
            saveVocab(v);
        }

        function sm2Schedule(word, q) {
            const quality = Math.max(0, Math.min(5, Number(q) || 0));
            let { ef = 2.5, rep = 0, interval = 0 } = word;

            if (quality < 3) {
                rep = 0; interval = 1;
            } else {
                if (rep === 0) { interval = 1; rep = 1; }
                else if (rep === 1) { interval = 6; rep = 2; }
                else { interval = Math.round(interval * ef); rep += 1; }
                ef = ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                if (ef < 1.3) ef = 1.3;
            }
            word.ef = ef; word.rep = rep; word.interval = interval;
            word.due = addDaysISO(interval);
            word.last = Date.now();
            return word;
        }

        function getActiveDeck() {
            const v = ensureVocab();
            if (!v.activeDeckId) return null;
            return v.decks[v.activeDeckId] || null;
        }
        function getDueWords(limit) {
            const deck = getActiveDeck(); if (!deck) return [];
            const today = isoToday();
            const pool = (deck.words || []).map(ensureWordSchedule)
                .filter(w => !w.due || w.due <= today);
            if (typeof limit !== "number") return pool;
            // simple shuffle
            const arr = [...pool]; for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[arr[i], arr[j]] = [arr[j], arr[i]]; }
            return arr.slice(0, Math.max(1, limit));
        }

        function updateVocabKPI() {
            const deck = getActiveDeck();
            const due = deck ? getDueWords().length : 0;
            const total = deck ? (deck.words || []).length : 0;
            const avgEF = deck && total ? ((deck.words || []).reduce((s, w) => s + (w.ef || 2.5), 0) / total).toFixed(2) : "‚Äî";
            const k1 = document.getElementById("vocabDueToday"); if (k1) k1.textContent = due;
            const s1 = document.getElementById("vStatTotal"); if (s1) s1.textContent = total;
            const s2 = document.getElementById("vStatDue"); if (s2) s2.textContent = due;
            const s3 = document.getElementById("vStatEF"); if (s3) s3.textContent = avgEF;

            // KPI badge tr√™n c·ª•m KPI ƒë·∫ßu trang
            let pill = document.getElementById("kpi-vocab");
            const kpiWrap = document.querySelector(".kpi");
            if (kpiWrap && !pill) {
                pill = document.createElement("span");
                pill.id = "kpi-vocab"; pill.className = "pill";
                kpiWrap.appendChild(pill);
            }
            if (pill) { pill.innerHTML = `üìò T·ª´ c·∫ßn √¥n: <b>${due}</b>`; }
        }

        // --- Tabs (Plan/Deck/Train/Stats) ---
        function bindVocabTabs() {
            const tabs = document.querySelectorAll(".tab[data-vtab]");
            const panes = document.querySelectorAll("[data-vpane]");
            tabs.forEach(t => {
                t.onclick = () => {
                    tabs.forEach(x => x.classList.remove("active"));
                    t.classList.add("active");
                    const id = t.getAttribute("data-vtab");
                    panes.forEach(p => { p.style.display = (p.getAttribute("data-vpane") === id) ? "block" : "none"; });
                };
            });
        }

        // --- Card renderers ---
        function renderFlash(w) {
            const el = document.createElement("div");
            el.innerHTML = `
    <div class="flash-front" id="vfFront">
      <b>${escapeHtml(w.term)}</b>
      <div class="small-muted">${(w.pos || []).join(", ")}</div>
    </div>
    <div class="flash-back" id="vfBack" style="display:none">
      <div><b>Nghƒ©a:</b> ${escapeHtml(w.meaning || "(ch∆∞a c√≥)")}</div>
      <div><b>ƒê·ªìng nghƒ©a:</b> ${escapeHtml((w.synonyms || []).slice(0, 5).join(", ") || "‚Äî")}</div>
      <div><b>Tr√°i nghƒ©a:</b> ${escapeHtml((w.antonyms || []).slice(0, 5).join(", ") || "‚Äî")}</div>
      <div><b>V√≠ d·ª•:</b> ${escapeHtml(w.example || "‚Äî")}</div>
    </div>
    <div class="flash-actions" style="margin-top:8px">
      <button class="btn" id="vShow">üëÅÔ∏è Show</button>
    </div>`;
            el.querySelector("#vShow").onclick = () => {
                el.querySelector("#vfFront").style.display = "none";
                el.querySelector("#vfBack").style.display = "block";
            };
            return el;
        }
        function renderCloze(w) {
            const src = w.example || `I will use the word "${w.term}" in a sentence.`;
            const rx = new RegExp(`\\b${w.term}\\b`, "gi");
            const cloze = src.replace(rx, "_____");
            const el = document.createElement("div");
            el.className = "cloze-card";
            el.innerHTML = `
    <div><b>ƒêi·ªÅn khuy·∫øt</b></div>
    <div style="margin-top:6px">${escapeHtml(cloze)}</div>
    <div class="row" style="margin-top:8px">
      <input id="vClozeAns" placeholder="T·ª´ c√≤n thi·∫øu l√† g√¨?">
      <button class="btn" id="vCheckCloze">Ki·ªÉm tra</button>
    </div>
    <div class="small-muted">G·ªëc: ${escapeHtml(src)}</div>`;
            el.querySelector("#vCheckCloze").onclick = () => {
                const a = el.querySelector("#vClozeAns").value.trim().toLowerCase();
                alert(a === String(w.term || "").toLowerCase() ? "‚úÖ Ch√≠nh x√°c." : `‚ùå ƒê√°p √°n: ${w.term}`);
            };
            return el;
        }
        function renderQuiz(w) {
            const el = document.createElement("div");
            el.className = "quiz-card";
            let question = "", answer = "", options = [];
            const poolSyn = (getActiveDeck()?.words || []).flatMap(x => x.synonyms || []);
            const poolAnt = (getActiveDeck()?.words || []).flatMap(x => x.antonyms || []);
            function sample(arr, n) {
                const a = [...arr].filter(Boolean); for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[a[i], a[j]] = [a[j], a[i]]; }
                return a.slice(0, n);
            }

            if ((w.synonyms || []).length) {
                question = `Ch·ªçn t·ª´ ƒë·ªìng nghƒ©a v·ªõi ‚Äú${w.term}‚Äù`;
                answer = sample(w.synonyms, 1)[0];
                options = sample([answer, ...sample(poolSyn.filter(x => x !== answer), 8)], 4);
            } else if ((w.antonyms || []).length) {
                question = `Ch·ªçn t·ª´ tr√°i nghƒ©a v·ªõi ‚Äú${w.term}‚Äù`;
                answer = sample(w.antonyms, 1)[0];
                options = sample([answer, ...sample(poolAnt.filter(x => x !== answer), 8)], 4);
            } else {
                question = `‚Äú${w.term}‚Äù c√≥ nghƒ©a g·∫ßn v·ªõi:`;
                answer = (w.meaning || "").split(/[;,]/)[0] || "(ch∆∞a c√≥)";
                const pool = (getActiveDeck()?.words || [])
                    .map(x => (x.meaning || "").split(/[;,]/)[0])
                    .filter(x => x && x !== answer);
                options = sample([answer, ...sample(pool, 8)], 4);
            }
            el.innerHTML = `<div><b>${escapeHtml(question)}</b></div>`;
            const wrap = document.createElement("div"); wrap.className = "row"; wrap.style.marginTop = "6px";
            options.forEach(opt => {
                const b = document.createElement("button");
                b.type = "button"; b.className = "choice"; b.textContent = opt;
                b.onclick = () => { if (opt === answer) b.classList.add("correct"); else b.classList.add("wrong"); };
                wrap.appendChild(b);
            });
            el.appendChild(wrap);
            el.appendChild(Object.assign(document.createElement("div"), { className: "small-muted", innerHTML: `ƒê√°p √°n: <b>${escapeHtml(answer)}</b>` }));
            return el;
        }
        function renderSentence(w) {
            const el = document.createElement("div");
            el.className = "sentence-card";
            el.innerHTML = `
    <div><b>ƒê·∫∑t c√¢u v·ªõi ‚Äú${escapeHtml(w.term)}‚Äù</b></div>
    <textarea id="vSentence" rows="3" placeholder="Vi·∫øt c√¢u c·ªßa b·∫°n..."></textarea>
    <div class="row" style="margin-top:8px">
      <span class="small-muted">G·ª£i √Ω: ${escapeHtml(w.meaning || "‚Äî")} | Syn: ${(w.synonyms || []).slice(0, 3).join(", ") || "‚Äî"}</span>
    </div>`;
            return el;
        }
        function pickMode(w) {
            const modes = ["flash", "quiz", "cloze", "sentence"];
            if (!(w.synonyms || []).length && !(w.antonyms || []).length) return Math.random() < 0.5 ? "flash" : "sentence";
            return modes[Math.floor(Math.random() * modes.length)];
        }

        // --- Session state ---
        let vSession = { queue: [], idx: 0, mode: "auto" };

        function renderCurrentCard() {
            const area = document.getElementById("vCardArea"); if (!area) return;
            area.innerHTML = "";
            const w = vSession.queue[vSession.idx]; if (!w) { area.innerHTML = `<div class="empty">H·∫øt th·∫ª.</div>`; return; }
            const mode = (vSession.mode === "auto") ? pickMode(w) : vSession.mode;
            let view;
            if (mode === "flash") view = renderFlash(w);
            else if (mode === "quiz") view = renderQuiz(w);
            else if (mode === "cloze") view = renderCloze(w);
            else view = renderSentence(w);
            area.appendChild(view);
        }

        function startVocabSession() {
            normalizeAllWords();
            const batchSel = document.getElementById("vBatch");
            const modeSel = document.getElementById("vMode");
            const batch = Number(batchSel ? batchSel.value : 20) || 20;
            const mode = modeSel ? modeSel.value : "auto";
            const due = getDueWords(batch);
            vSession.queue = due;
            vSession.idx = 0;
            vSession.mode = mode;
            const panel = document.getElementById("vSession");
            if (!panel) return;
            if (!due.length) { alert("Kh√¥ng c√≥ th·∫ª ƒë·∫øn h·∫°n."); panel.style.display = "none"; return; }
            panel.style.display = "block";
            renderCurrentCard();
        }

        function submitVocabGrade(skip) {
            const deck = getActiveDeck(); if (!deck) return;
            if (!vSession.queue.length) return;
            const w = vSession.queue[vSession.idx];
            if (!skip) {
                const picked = document.querySelector('input[name="vGrade"]:checked');
                const q = picked ? Number(picked.value) : 3;
                sm2Schedule(w, q);
                // persist back
                deck.words = deck.words.map(x => x.id === w.id ? w : x);
                const v = ensureVocab(); v.decks[deck.id || v.activeDeckId] = deck; saveVocab(v);
            }
            vSession.idx++;
            if (vSession.idx >= vSession.queue.length) {
                document.getElementById("vSession").style.display = "none";
                updateVocabKPI();
                alert("Ho√†n t·∫•t session üéâ");
                return;
            }
            renderCurrentCard();
        }

        // --- Bind UI once DOM ready (independent of existing handlers) ---
        document.addEventListener("DOMContentLoaded", () => {
            // normalize/counters
            normalizeAllWords();
            updateVocabKPI();
            bindVocabTabs();

            const btnStart = document.getElementById("vStartSession");
            if (btnStart) btnStart.onclick = startVocabSession;

            const quickBtn = document.getElementById("vocabStartBtn");
            if (quickBtn) quickBtn.onclick = () => {
                const trainTab = document.querySelector('.tab[data-vtab="train"]');
                if (trainTab) trainTab.click();
                startVocabSession();
            };

            const btnSubmit = document.getElementById("vSubmitGrade");
            if (btnSubmit) btnSubmit.onclick = () => submitVocabGrade(false);
            const btnSkip = document.getElementById("vSkip");
            if (btnSkip) btnSkip.onclick = () => submitVocabGrade(true);

            // khi thao t√°c Deck/Words thay ƒë·ªïi d·ªØ li·ªáu -> refresh KPI
            const observer = new MutationObserver(() => updateVocabKPI());
            const wordList = document.getElementById("vWordList");
            if (wordList) observer.observe(wordList, { childList: true, subtree: true });
            // c≈©ng refresh KPI m·ªói khi m·ªü tab Deck/Train
            document.querySelectorAll(".tab[data-vtab]").forEach(t => {
                t.addEventListener("click", updateVocabKPI);
            });
        });
        // ===== End Vocab Trainer + SM-2 =====
        document.addEventListener("DOMContentLoaded", () => {
            function ensureClassIds() {
                const arr = store.get(KEY.CLASSES, []).map(c => ({ ...c, id: c.id ? String(c.id) : uid() }));
                store.set(KEY.CLASSES, arr);
            }
            store.init();
            // ==== VOCAB INIT ====
            ensureVocab();
            renderVocabDeckList();
            renderVocabWords();

            // Create deck
            $("#vDeckForm").onsubmit = (e) => {
                e.preventDefault();
                const name = e.target.name.value.trim();
                if (!name) return;
                const v = ensureVocab();
                const id = newId();
                v.decks[id] = { id, name, words: [] };
                v.activeDeckId = id;
                saveVocab(v);
                e.target.reset();
                selectedWordIds.clear(); $("#vSelWordsCount").textContent = 0;
                renderVocabDeckList(); renderVocabWords();
            };

            // Import words (simple parser: "term|meaning")
            $("#vImportForm").onsubmit = (e) => {
                e.preventDefault();
                const f = e.target;
                const bulk = (f.bulk.value || "").trim();
                const deckId = f.deck.value;
                if (!deckId) { alert("Ch∆∞a ch·ªçn deck."); return; }
                const v = ensureVocab();
                const deck = v.decks[deckId];
                if (!deck) { alert("Deck kh√¥ng t·ªìn t·∫°i."); return; }
                const lines = bulk.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                const toAdd = lines.map(line => {
                    const [term, meaning = ''] = line.split("|");
                    return { id: newId(), term: term?.trim() || "", meaning: meaning?.trim() || "", pos: "", notes: "" };
                }).filter(x => x.term);

                deck.words = (deck.words || []).concat(toAdd);
                // optional enrich: b·ªè qua ƒë·ªÉ gi·ªØ t·ªëc ƒë·ªô
                saveVocab(v);
                f.reset();
                renderVocabDeckList(); renderVocabWords();
            };

            // Select all
            $("#vSelectAllWords").onchange = (e) => {
                const v = ensureVocab();
                const deck = v.activeDeckId ? v.decks[v.activeDeckId] : null;
                selectedWordIds.clear();
                if (e.target.checked && deck) {
                    (deck.words || []).forEach(w => selectedWordIds.add(String(w.id)));
                }
                $("#vSelWordsCount").textContent = selectedWordIds.size;
                renderVocabWords();
                // keep the master checkbox state consistent after re-render
                $("#vSelectAllWords").checked = e.target.checked;
            };

            // Bulk delete selected
            $("#vDeleteSelectedWords").onclick = () => {
                if (selectedWordIds.size === 0) return;
                const v = ensureVocab();
                const did = v.activeDeckId;
                if (!did || !v.decks[did]) return;
                if (!confirm(`Xo√° ${selectedWordIds.size} t·ª´ ƒë√£ ch·ªçn?`)) return;
                const deck = v.decks[did];
                deck.words = (deck.words || []).filter(w => !selectedWordIds.has(String(w.id)));
                saveVocab(v);
                selectedWordIds.clear();
                $("#vSelWordsCount").textContent = 0;
                $("#vSelectAllWords").checked = false;
                renderVocabDeckList(); renderVocabWords();
            };

            // Sync label quota/active deck name on load
            (() => {
                const v = ensureVocab();
                $("#vActiveDeckName").textContent = v.activeDeckId ? (v.decks[v.activeDeckId]?.name || "‚Äî") : "‚Äî";
            })();

            ensureIds(); renderAll();
            ensureClassIds(); ensureLifeIds();
            // ==== VOCAB INIT ====
            // Switch active deck from the words panel
            const activeSel = $("#vActiveDeckSelect");
            if (activeSel) {
                activeSel.onchange = () => {
                    const v = ensureVocab();
                    v.activeDeckId = activeSel.value || null;
                    saveVocab(v);
                    selectedWordIds.clear();
                    $("#vSelWordsCount").textContent = 0;
                    $("#vSelectAllWords").checked = false;
                    $("#vActiveDeckName").textContent = v.activeDeckId ? (v.decks[v.activeDeckId]?.name || "‚Äî") : "‚Äî";
                    populateDeckSelects();
                    renderVocabDeckList();
                    renderVocabWords();
                };
            }

            // Also: when user changes the Import form deck, set active for consistency
            const importSel = $("#vDeckSelect");
            if (importSel) {
                importSel.onchange = () => {
                    const v = ensureVocab();
                    v.activeDeckId = importSel.value || null;
                    saveVocab(v);
                    selectedWordIds.clear();
                    $("#vSelWordsCount").textContent = 0;
                    $("#vSelectAllWords").checked = false;
                    $("#vActiveDeckName").textContent = v.activeDeckId ? (v.decks[v.activeDeckId]?.name || "‚Äî") : "‚Äî";
                    populateDeckSelects();
                    renderVocabDeckList();
                    renderVocabWords();
                };
            }

            ensureVocab();
            populateDeckSelects();
            renderVocabDeckList();
            function populateDeckSelects() {
                const v = ensureVocab();
                const ids = Object.keys(v.decks);

                // Import form select
                const importSel = $("#vDeckSelect");
                if (importSel) {
                    importSel.innerHTML = ids.length ? "" : `<option value="">(Ch∆∞a c√≥ deck)</option>`;
                    ids.forEach(id => {
                        const opt = document.createElement("option");
                        opt.value = id; opt.textContent = v.decks[id].name;
                        importSel.appendChild(opt);
                    });
                    if (v.activeDeckId && v.decks[v.activeDeckId]) importSel.value = v.activeDeckId;
                }

                // Active deck switcher (xo√° t·ª´)
                const activeSel = $("#vActiveDeckSelect");
                if (activeSel) {
                    activeSel.innerHTML = ids.length ? "" : `<option value="">(Ch∆∞a c√≥ deck)</option>`;
                    ids.forEach(id => {
                        const opt = document.createElement("option");
                        opt.value = id; opt.textContent = v.decks[id].name;
                        activeSel.appendChild(opt);
                    });
                    if (v.activeDeckId && v.decks[v.activeDeckId]) activeSel.value = v.activeDeckId;
                }
            }

            renderVocabWords();

            // Create deck
            $("#vDeckForm").onsubmit = (e) => {
                e.preventDefault();
                const name = e.target.name.value.trim();
                if (!name) return;
                const v = ensureVocab();
                const id = newId();
                v.decks[id] = { id, name, words: [] };
                v.activeDeckId = id;
                saveVocab(v);
                e.target.reset();
                selectedWordIds.clear(); $("#vSelWordsCount").textContent = 0;
                renderVocabDeckList(); renderVocabWords();
            };

            // Import words (simple parser: "term|meaning")
            $("#vImportForm").onsubmit = (e) => {
                e.preventDefault();
                const f = e.target;
                const bulk = (f.bulk.value || "").trim();
                const deckId = f.deck.value;
                if (!deckId) { alert("Ch∆∞a ch·ªçn deck."); return; }
                const v = ensureVocab();
                const deck = v.decks[deckId];
                if (!deck) { alert("Deck kh√¥ng t·ªìn t·∫°i."); return; }
                const lines = bulk.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                const toAdd = lines.map(line => {
                    const [term, meaning = ''] = line.split("|");
                    return { id: newId(), term: term?.trim() || "", meaning: meaning?.trim() || "", pos: "", notes: "" };
                }).filter(x => x.term);

                deck.words = (deck.words || []).concat(toAdd);
                // optional enrich: b·ªè qua ƒë·ªÉ gi·ªØ t·ªëc ƒë·ªô
                saveVocab(v);
                f.reset();
                renderVocabDeckList(); renderVocabWords();
            };

            // Select all
            $("#vSelectAllWords").onchange = (e) => {
                const v = ensureVocab();
                const deck = v.activeDeckId ? v.decks[v.activeDeckId] : null;
                selectedWordIds.clear();
                if (e.target.checked && deck) {
                    (deck.words || []).forEach(w => selectedWordIds.add(String(w.id)));
                }
                $("#vSelWordsCount").textContent = selectedWordIds.size;
                renderVocabWords();
                // keep the master checkbox state consistent after re-render
                $("#vSelectAllWords").checked = e.target.checked;
            };

            // Bulk delete selected
            $("#vDeleteSelectedWords").onclick = () => {
                if (selectedWordIds.size === 0) return;
                const v = ensureVocab();
                const did = v.activeDeckId;
                if (!did || !v.decks[did]) return;
                if (!confirm(`Xo√° ${selectedWordIds.size} t·ª´ ƒë√£ ch·ªçn?`)) return;
                const deck = v.decks[did];
                deck.words = (deck.words || []).filter(w => !selectedWordIds.has(String(w.id)));
                saveVocab(v);
                selectedWordIds.clear();
                $("#vSelWordsCount").textContent = 0;
                $("#vSelectAllWords").checked = false;
                renderVocabDeckList(); renderVocabWords();
            };

            // ‚ÄúXo√° deck ƒëang ch·ªçn‚Äù (n√∫t ·ªü tab Stats ƒë√£ c√≥ s·∫µn id)
            const delDeckBtn = $("#vDeleteDeck");
            if (delDeckBtn) {
                delDeckBtn.onclick = () => {
                    const v = ensureVocab();
                    const did = v.activeDeckId;
                    if (!did || !v.decks[did]) { alert("Ch∆∞a c√≥ deck ƒëang ch·ªçn."); return; }
                    if (!confirm(`Xo√° deck "${v.decks[did].name}"?`)) return;
                    delete v.decks[did];
                    v.activeDeckId = Object.keys(v.decks)[0] || null;
                    saveVocab(v);
                    selectedWordIds.clear(); $("#vSelWordsCount").textContent = 0;
                    $("#vSelectAllWords").checked = false;
                    renderVocabDeckList(); renderVocabWords();
                };
            }

            // Sync label quota/active deck name on load
            (() => {
                const v = ensureVocab();
                $("#vActiveDeckName").textContent = v.activeDeckId ? (v.decks[v.activeDeckId]?.name || "‚Äî") : "‚Äî";
            })();

            // ======= Export / Import bindings =======
            $("#exportBtn").onclick = () => {
                exportAll();
            };

            $("#importBtn").onclick = () => {
                const mode = confirm("OK = REPLACE (ghi ƒë√®), Cancel = MERGE (g·ªôp th√¥ng minh).") ? "replace" : "merge";
                const fi = $("#importFile");
                fi.value = "";
                fi.onchange = (e) => {
                    const file = e.target.files?.[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = () => importAllFromText(String(reader.result || ""), { mode });
                    reader.readAsText(file, "utf-8");
                };
                fi.click();
            };



            // Defaults
            $("#todoForm [name='due']").value = todayStr();

            // Add
            $("#todoForm").onsubmit = (e) => {
                e.preventDefault();
                const f = e.target;
                const obj = {
                    id: uid(),
                    title: f.title.value.trim(),
                    due: f.due.value,
                    tag: f.tag.value.trim(),
                    done: !!f.done.checked
                };
                const arr = store.get(KEY.TODOS, []);
                arr.push(obj);
                store.set(KEY.TODOS, arr);

                // reset form v·ªÅ m·∫∑c ƒë·ªãnh
                f.reset();
                $("#todoForm [name='due']").value = todayStr();
                renderTodos(); renderKPIs();
            };

            // Filters
            $("#fStatus").onchange = e => { todoFilter.status = e.target.value; renderTodos(); renderKPIs(); };
            $("#fDue").onchange = e => { todoFilter.due = e.target.value; renderTodos(); renderKPIs(); };
            $("#fTag").oninput = e => { todoFilter.tag = e.target.value.trim(); renderTodos(); };
            $("#fSearch").oninput = e => { todoFilter.q = e.target.value.trim(); renderTodos(); };
            $("#fClear").onclick = () => {
                todoFilter.status = 'all'; todoFilter.due = 'today'; todoFilter.tag = ''; todoFilter.q = '';
                $("#fStatus").value = 'all'; $("#fDue").value = 'today'; $("#fTag").value = ''; $("#fSearch").value = '';
                renderTodos(); renderKPIs();
            };

            // Bulk ops
            $("#bulkDone").onclick = () => {
                if (selectedIds.size === 0) return;
                const arr = store.get(KEY.TODOS, []);
                arr.forEach(t => { if (selectedIds.has(String(t.id))) t.done = true; });
                store.set(KEY.TODOS, arr);
                selectedIds.clear(); $("#selCount").textContent = 0;
                renderTodos(); renderKPIs();
            };
            $("#bulkDelete").onclick = () => {
                if (selectedIds.size === 0) return;
                const arr = store.get(KEY.TODOS, []).filter(t => !selectedIds.has(String(t.id)));
                store.set(KEY.TODOS, arr);
                selectedIds.clear(); $("#selCount").textContent = 0;
                renderTodos(); renderKPIs();
            };

            // Rollover: MOVE unfinished today -> tomorrow
            $("#rollToTomorrow").onclick = () => {
                const arr = store.get(KEY.TODOS, []);
                const today = todayStr();
                const tomorrow = addDaysStr(1);
                let moved = 0;
                arr.forEach(t => { if (t.due === today && !t.done) { t.due = tomorrow; moved++; } });
                if (moved === 0) { alert("Tuy·ªát v·ªùi! Kh√¥ng c√≤n vi·ªác t·ªìn ƒë·ªçng h√¥m nay."); return; }
                store.set(KEY.TODOS, arr); renderTodos(); renderKPIs();
                alert(`ƒê√£ chuy·ªÉn ${moved} vi·ªác sang ng√†y mai (${tomorrow}).`);
            };

            // Profile modal
            $("#editProfileBtn").onclick = () => {
                const p = store.get(KEY.PROFILE, CONFIG.profile);
                const dlg = $("#profileModal");
                dlg.querySelector('[name="avatar"]').value = p.avatar || "";
                dlg.querySelector('[name="name"]').value = p.name || "";
                dlg.querySelector('[name="birthday"]').value = p.birthday || "";
                dlg.querySelector('[name="country"]').value = p.country || "";
                dlg.querySelector('[name="relationship"]').value = p.relationship || "";
                dlg.querySelector('[name="rel_label"]').value = (p.relationship_link?.label) || "";
                dlg.querySelector('[name="rel_url"]').value = (p.relationship_link?.url) || "";

                dlg.querySelector('[name="bio"]').value = p.bio || "";
                dlg.querySelector('[name="links"]').value = (p.links || []).map(([l, u]) => `${l}|${u}`).join("\n");
                dlg.showModal();
                dlg.addEventListener('close', () => {
                    if (dlg.returnValue === "save") {
                        const np = {
                            avatar: dlg.querySelector('[name="avatar"]').value.trim(),
                            name: dlg.querySelector('[name="name"]').value.trim(),
                            birthday: dlg.querySelector('[name="birthday"]').value,
                            country: dlg.querySelector('[name="country"]').value.trim(),
                            relationship: dlg.querySelector('[name="relationship"]').value.trim(),
                            bio: dlg.querySelector('[name="bio"]').value.trim(),
                            links: dlg.querySelector('[name="links"]').value.split("\n").filter(Boolean).map(line => {
                                const [label, url] = line.split("|"); return [(label || "").trim(), (url || "").trim()];
                            }),
                            relationship_link: {
                                label: dlg.querySelector('[name="rel_label"]').value.trim(),
                                url: dlg.querySelector('[name="rel_url"]').value.trim()
                            }
                        };

                        store.set(KEY.PROFILE, np); renderProfile();
                    }
                }, { once: true });
            };

            $("#resetDataBtn").onclick = () => {
                if (confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu local v√† n·∫°p l·∫°i t·ª´ CONFIG?")) store.reset();
            };

            // Class form
            $("#classForm").onsubmit = (e) => {
                e.preventDefault();
                const f = e.target;
                const payload = {
                    day: +f.day.value,
                    start: f.start.value,
                    end: f.end.value,
                    subject: f.subject.value.trim(),
                    note: (f.note.value || "").trim(),
                    homework: f.homework.value
                };

                const arr = store.get(KEY.CLASSES, []);
                if (classEditingId) {
                    // UPDATE theo ID
                    const i = arr.findIndex(c => String(c.id) === String(classEditingId));
                    if (i > -1) arr[i] = { ...arr[i], ...payload }; // gi·ªØ nguy√™n id
                    classEditingId = null;
                } else {
                    // CREATE
                    arr.push({ id: uid(), ...payload });
                }
                store.set(KEY.CLASSES, arr);

                // reset form + n√∫t
                f.reset();
                const submitBtn = f.querySelector('button[type="submit"]');
                if (submitBtn) { submitBtn.textContent = "‚ûï Th√™m v√†o TKB"; }

                renderClasses(); renderKPIs();
            };

            $("#clearClasses").onclick = () => {
                if (confirm("X√≥a to√†n b·ªô th·ªùi kh√≥a bi·ªÉu?")) { store.set(KEY.CLASSES, []); renderClasses(); renderKPIs(); }
            };

            // Life form
            // Life form (CREATE/UPDATE by id)
            $("#lifeForm").onsubmit = (e) => {
                e.preventDefault();
                const f = e.target;
                const payload = {
                    day: +f.day.value,
                    block: f.block.value,
                    title: f.title.value.trim(),
                    note: (f.note.value || "").trim(),
                    repeat: f.repeat.value
                };
                const arr = store.get(KEY.LIFE, []);

                if (lifeEditingId) {
                    const i = arr.findIndex(x => String(x.id) === String(lifeEditingId));
                    if (i > -1) arr[i] = { ...arr[i], ...payload };  // gi·ªØ nguy√™n id, update field
                    lifeEditingId = null;
                } else {
                    arr.push({ id: uid(), ...payload });
                }

                store.set(KEY.LIFE, arr);
                // reset form & n√∫t
                f.reset();
                const submitBtn = f.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.textContent = "‚ûï Th√™m l·ªãch";
                renderLife();
            };


            // To-do form
            $("#todoForm").onsubmit = (e) => {
                e.preventDefault();
                const f = e.target;
                const obj = {
                    id: (Date.now() + Math.random()).toString(36),
                    title: f.title.value.trim(), due: f.due.value, tag: f.tag.value.trim(), done: false
                };
                const arr = store.get(KEY.TODOS, []); arr.push(obj); store.set(KEY.TODOS, arr);
                f.reset(); renderTodos(); renderKPIs();
            };
            $("#rollToTomorrow").onclick = () => {
                const arr = store.get(KEY.TODOS, []);
                const today = todayStr();
                const tomorrow = addDaysStr(1);
                let moved = 0;

                // MOVE: chuy·ªÉn h·∫°n c√°c vi·ªác ch∆∞a xong h√¥m nay sang ng√†y mai (kh√¥ng t·∫°o b·∫£n sao)
                arr.forEach(t => {
                    if (t.due === today && !t.done) {
                        t.due = tomorrow;
                        moved++;
                    }
                });

                if (moved === 0) {
                    alert("Tuy·ªát v·ªùi! Kh√¥ng c√≤n vi·ªác t·ªìn ƒë·ªçng h√¥m nay.");
                    return;
                }
                store.set(KEY.TODOS, arr);
                renderTodos();
                renderKPIs();
                alert(`ƒê√£ chuy·ªÉn ${moved} vi·ªác sang ng√†y mai (${tomorrow}).`);
            };
            const fd = $("#todoForm [name='done']"); if (fd) fd.checked = false;

        });

    </script>
    <script src="main.js"></script>
    <dialog id="paraModal" style="border:none;border-radius:16px;padding:0;max-width:420px;width:92%">
        <form method="dialog" class="card" style="background:#0f1623">
            <h3 class="title">‚ûï Th√™m PARA</h3>

            <label>Lo·∫°i</label>
            <select name="type">
                <option value="projects">Project</option>
                <option value="areas">Area</option>
                <option value="resources">Resource</option>
            </select>

            <label>Ti√™u ƒë·ªÅ</label>
            <input name="title" required placeholder="T√™n project / area / resource">

            <label>Ghi ch√∫</label>
            <textarea name="note" rows="3"></textarea>

            <div class="row" style="margin-top:10px">
                <button class="btn ghost" value="cancel">H·ªßy</button>
                <div class="sp"></div>
                <button class="btn primary" value="save">L∆∞u</button>
            </div>
        </form>
    </dialog>
</body>

</html>